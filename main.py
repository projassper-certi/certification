import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd

# [í•µì‹¬] ê¸°ì¡´ì˜ ê¼¬ì¸ ê¸°ì–µ(ìºì‹œ)ì„ ì‚­ì œí•©ë‹ˆë‹¤. (ì—ëŸ¬ ë°©ì§€ìš©)
st.cache_data.clear()

st.set_page_config(layout="wide")
st.title("ğŸ¥ 2025ë…„ë„ ì¸ì¦ ì¡°ì‚¬ í‰ê°€ ì‹œìŠ¤í…œ")

# 1. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°
conn = st.connection("gsheets", type=GSheetsConnection)

try:
    # ---------------------------------------------------------
    # 2. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤!)
    # ---------------------------------------------------------
    
    # (1) ê´€ë¦¬ì ì‹œíŠ¸ ì½ê¸° (ì‹œíŠ¸ ì´ë¦„: admin)
    # í˜¹ì‹œ ë˜ ì—ëŸ¬ë‚˜ë©´ worksheet="admin" ëŒ€ì‹  worksheet=1 ë¡œ ë°”ê¿”ë³´ì„¸ìš”.
    df_admin = conn.read(worksheet="admin", usecols=['ì´ë¦„', 'ê¸°ì¤€ë²ˆí˜¸'])
    
    # (2) ì„¤ë¬¸ ë°ì´í„° ì‹œíŠ¸ ì½ê¸° (ì‹œíŠ¸ ì´ë¦„: ì„¤ë¬¸ë°ì´í„°)
    # skiprows=1 : ë§¨ ìœ—ì¤„(<ë¶™ì„ 1>...)ì„ ê±´ë„ˆë›°ê³  ì§„ì§œ ì œëª©ì¤„ë¶€í„° ì½ìŠµë‹ˆë‹¤.
    df_main = conn.read(worksheet="ì„¤ë¬¸ë°ì´í„°", skiprows=1)
    
    # (3) ë°ì´í„° ë‹¤ë“¬ê¸°
    # 'ê¸°ì¤€ë²ˆí˜¸'ê°€ ë¹„ì–´ìˆëŠ” ì¡ë‹¤í•œ ì¤„(í–‰)ì€ ì‚­ì œí•©ë‹ˆë‹¤.
    df_main = df_main.dropna(subset=['ê¸°ì¤€ë²ˆí˜¸'])
    # ìˆ«ì 1.1ê³¼ ë¬¸ì "1.1"ì´ í—·ê°ˆë¦¬ì§€ ì•Šê²Œ ì „ë¶€ ë¬¸ìë¡œ í†µì¼í•©ë‹ˆë‹¤.
    df_main['ê¸°ì¤€ë²ˆí˜¸'] = df_main['ê¸°ì¤€ë²ˆí˜¸'].astype(str)

except Exception as e:
    st.error(f"ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ! ì—ëŸ¬ ë‚´ìš©: {e}")
    st.stop()

# ---------------------------------------------------------
# 3. ì‚¬ì´ë“œë°” ë¡œê·¸ì¸ í™”ë©´
# ---------------------------------------------------------
with st.sidebar:
    st.header("ğŸ” ìœ„ì› ë¡œê·¸ì¸")
    st.write("ê´€ë¦¬ì ì‹œíŠ¸ì— ë“±ë¡ëœ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.")
    input_name = st.text_input("ì„±í•¨ ì…ë ¥", placeholder="ì˜ˆ: ê¹€ì² ìˆ˜")

# ---------------------------------------------------------
# 4. ë©”ì¸ ë¡œì§ (ë¡œê·¸ì¸ í›„ í™”ë©´)
# ---------------------------------------------------------
if input_name:
    # 4-1. admin ì‹œíŠ¸ì—ì„œ ì´ë¦„ ì°¾ê¸°
    user_row = df_admin[df_admin['ì´ë¦„'] == input_name]
    
    if user_row.empty:
        st.error(f"â›” '{input_name}' ìœ„ì›ë‹˜ì€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        st.info("admin ì‹œíŠ¸ì— ì´ë¦„ì´ ì •í™•íˆ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    else:
        st.success(f"ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, **{input_name}** ìœ„ì›ë‹˜!")
        
        # 4-2. ê¶Œí•œ ê°€ì ¸ì˜¤ê¸° (ì½¤ë§ˆë¡œ ëœ ê¸€ìë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜)
        # ì˜ˆ: "1.1, 1.2" -> ['1.1', '1.2']
        permission_str = str(user_row.iloc[0]['ê¸°ì¤€ë²ˆí˜¸'])
        target_ids = [x.strip() for x in permission_str.split(',')]
        
        # 4-3. ë‚´ ë²ˆí˜¸ë§Œ í•„í„°ë§í•˜ê¸°
        my_data = df_main[df_main['ê¸°ì¤€ë²ˆí˜¸'].isin(target_ids)]
        
        if my_data.empty:
            st.warning(f"ë°°ì •ëœ ê¸°ì¤€ë²ˆí˜¸({target_ids})ì— í•´ë‹¹í•˜ëŠ” ë¬¸í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.write(f"ì´ **{len(my_data)}ê°œ**ì˜ í‰ê°€ ë¬¸í•­ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            # 4-4. í‰ê°€ í™”ë©´ ë³´ì—¬ì£¼ê¸°
            # (columns ë¦¬ìŠ¤íŠ¸ì— ì—‘ì…€ì˜ ì‹¤ì œ ì—´ ì´ë¦„ë“¤ì„ ì ì–´ì£¼ë©´ ë” ê¹”ë”í•˜ê²Œ ë‚˜ì˜µë‹ˆë‹¤)
            st.data_editor(
                my_data,
                hide_index=True,
                use_container_width=True,
                height=600,
                key="editor"
            )
            
            # (ì €ì¥ ë²„íŠ¼ì€ ì¶”í›„ êµ¬í˜„)
            if st.button("í‰ê°€ ì™„ë£Œ ë° ì €ì¥"):
                st.toast("ì €ì¥ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë§Œë‚˜ìš”! ğŸš§")
                
else:
    # ë¡œê·¸ì¸ ì „ ì•ˆë‚´ í™”ë©´
    st.info("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    st.markdown("---")
    st.write("### ğŸ“‹ í˜„ì¬ ë“±ë¡ëœ ìœ„ì› ëª…ë‹¨ (í…ŒìŠ¤íŠ¸ìš©)")
    st.dataframe(df_admin)