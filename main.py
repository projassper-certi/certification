import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd

# íŽ˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ì²´í¬ë¦¬ìŠ¤íŠ¸ í‰ê°€ ì‹œìŠ¤í…œ", layout="wide")

st.title("ðŸ“‹ ìš°ë¦¬ ë¶€ì„œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹œìŠ¤í…œ")

# 1. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° (ttl=0ì€ ìºì‹œë¥¼ ë°”ë¡œ ê°±ì‹ í•˜ì—¬ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
conn = st.connection("gsheets", type=GSheetsConnection)
data = conn.read(ttl=0)
df = pd.DataFrame(data)

# ë°ì´í„°í”„ë ˆìž„ì— í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ì¶”ê°€
if 'í‰ê°€' not in df.columns:
    df['í‰ê°€'] = ""
if 'ë‹´ë‹¹ìœ„ì›' not in df.columns:
    df['ë‹´ë‹¹ìœ„ì›'] = ""

# íƒ­ ë‚˜ëˆ„ê¸° (ì¼ë°˜ ìœ„ì›ìš© / ê´€ë¦¬ìžìš©)
tab1, tab2 = st.tabs(["ðŸ“ í‰ê°€í•˜ê¸° (ìœ„ì›ìš©)", "âš™ï¸ ê´€ë¦¬ìž (ë‹´ë‹¹ ë°°ì • ë° ê²°ê³¼)"])

# ==========================================
# [TAB 1] í‰ê°€ ìœ„ì›ìš© í™”ë©´
# ==========================================
with tab1:
    st.header("ìœ„ì› í‰ê°€ íŽ˜ì´ì§€")
    
    # 1. ì‚¬ìš©ìž ë¡œê·¸ì¸ (ì´ë¦„ ìž…ë ¥)
    user_name = st.text_input("ìœ„ì›ë‹˜ì˜ ì„±í•¨ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”", placeholder="ì˜ˆ: í™ê¸¸ë™")

    if user_name:
        # 2. ë‚´ ì´ë¦„ìœ¼ë¡œ ë°°ì •ëœ ë¬¸í•­ë§Œ í•„í„°ë§ (í–‰ ìˆ¨ê¸°ê¸° íš¨ê³¼)
        # ì¤‘ìš”: ì›ë³¸ ë°ì´í„°ì˜ ì¸ë±ìŠ¤ë¥¼ ìœ ì§€í•´ì•¼ ë‚˜ì¤‘ì— ì •í™•ížˆ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
        my_tasks = df[df['ë‹´ë‹¹ìœ„ì›'] == user_name]

        if my_tasks.empty:
            st.warning(f"'{user_name}' ìœ„ì›ë‹˜ê»˜ ë°°ì •ëœ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìž íƒ­ì—ì„œ ë¬¸í•­ì„ ë°°ì •í•´ì£¼ì„¸ìš”.")
        else:
            st.success(f"ë°˜ê°‘ìŠµë‹ˆë‹¤ {user_name} ìœ„ì›ë‹˜! ì´ {len(my_tasks)}ê°œì˜ ë¬¸í•­ì´ ìžˆìŠµë‹ˆë‹¤.")
            
            # 3. ë°ì´í„° ì—ë””í„° ë³´ì—¬ì£¼ê¸°
            # ìœ„ì›ì´ ìˆ˜ì •í•´ì•¼ í•  ì»¬ëŸ¼ ì„¤ì • (ì—¬ê¸°ì„œëŠ” 'í‰ê°€'ë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, íŽ¸ì˜ìƒ ë‹¤ ë³´ì—¬ì¤ë‹ˆë‹¤)
            # keyë¥¼ ì£¼ì–´ ìƒíƒœ ìœ ì§€
            edited_df = st.data_editor(
                my_tasks,
                column_config={
                    "í‰ê°€": st.column_config.TextColumn(
                        "í‰ê°€ ê²°ê³¼ ìž…ë ¥",
                        help="ì—¬ê¸°ì— í‰ê°€ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”",
                        required=True
                    ),
                    "ë‹´ë‹¹ìœ„ì›": st.column_config.Column(disabled=True), # ë‹´ë‹¹ìœ„ì›ì€ ìˆ˜ì • ë¶ˆê°€
                    "ë¬¸í•­": st.column_config.Column(disabled=True),
                    "ì§ˆë¬¸": st.column_config.Column(disabled=True),
                },
                hide_index=True,
                key="editor"
            )

            # 4. ì €ìž¥ ë²„íŠ¼ ë¡œì§ (ê°€ìž¥ ì¤‘ìš”í•œ ë¶€ë¶„!)
            if st.button("í‰ê°€ ì™„ë£Œ ë° ì €ìž¥", type="primary"):
                try:
                    # edited_dfëŠ” ë‚´ê°€ ìˆ˜ì •í•œ 'ì¼ë¶€ë¶„'ì˜ ë°ì´í„°ìž…ë‹ˆë‹¤.
                    # ì´ë¥¼ ì›ë³¸ dfì— ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.
                    # íŒë‹¤ìŠ¤ì˜ update ê¸°ëŠ¥ì„ ì“°ê±°ë‚˜ ì¸ë±ìŠ¤ë¥¼ ë§žì¶°ì„œ ê°’ì„ ëŒ€ìž…í•©ë‹ˆë‹¤.
                    
                    # ì‚¬ìš©ìžê°€ ìˆ˜ì •í•œ ë‚´ìš©ì„ ì›ë³¸ ë°ì´í„°(df)ì˜ í•´ë‹¹ ì¸ë±ìŠ¤ì— ë®ì–´ì”Œì›ë‹ˆë‹¤.
                    df.loc[edited_df.index, 'í‰ê°€'] = edited_df['í‰ê°€']
                    
                    # êµ¬ê¸€ ì‹œíŠ¸ì— ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œ
                    conn.update(data=df)
                    
                    st.toast("âœ… ì €ìž¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", icon="ðŸ’¾")
                    st.cache_data.clear() # ìºì‹œ ì´ˆê¸°í™”
                    st.rerun() # í™”ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìµœì‹  ìƒíƒœ ë°˜ì˜
                    
                except Exception as e:
                    st.error(f"ì €ìž¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# ==========================================
# [TAB 2] ê´€ë¦¬ìžìš© í™”ë©´
# ==========================================
with tab2:
    st.header("ê´€ë¦¬ìž íŽ˜ì´ì§€")
    
    # ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
    admin_pw = st.text_input("ê´€ë¦¬ìž ë¹„ë°€ë²ˆí˜¸", type="password")
    if admin_pw == "1234": # ì‹¤ì œ ì‚¬ìš©ì‹œì—” secrets.toml ë“±ìœ¼ë¡œ ê´€ë¦¬ ê¶Œìž¥
        
        st.subheader("1. ë¬¸í•­ ë°°ì •í•˜ê¸°")
        st.info("íŠ¹ì • ìœ„ì›ì—ê²Œ ë¬¸í•­ ë²ˆí˜¸ë¥¼ ìž…ë ¥í•˜ì—¬ ë°°ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.")
        
        col1, col2 = st.columns(2)
        with col1:
            target_member = st.text_input("ë°°ì •í•  ìœ„ì› ì´ë¦„ (ì˜ˆ: ê¹€ì² ìˆ˜)")
        with col2:
            # ë¬¸í•­ ë²ˆí˜¸ë¥¼ ì½¤ë§ˆë¡œ êµ¬ë¶„í•´ì„œ ë°›ê¸° (ì˜ˆ: 1,3,5,7)
            target_ids = st.text_input("ë°°ì •í•  ë¬¸í•­ ë²ˆí˜¸ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì˜ˆ: 1,3,5)")

        if st.button("ìœ„ì› ë°°ì • ì‹¤í–‰"):
            if target_member and target_ids:
                # ìž…ë ¥ë°›ì€ ë¬¸í•­ ë²ˆí˜¸ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
                try:
                    id_list = [x.strip() for x in target_ids.split(',')]
                    # ë¬¸í•­ ì»¬ëŸ¼ì´ ìˆ«ìží˜•ì¼ ìˆ˜ë„ ìžˆê³  ë¬¸ìží˜•ì¼ ìˆ˜ë„ ìžˆì–´ì„œ íƒ€ìž… ë§žì¶¤ (ì—¬ê¸°ì„  ë¬¸ìžì—´ë¡œ ì²˜ë¦¬)
                    
                    # ì¡°ê±´: 'ë¬¸í•­' ì»¬ëŸ¼ì˜ ê°’ì´ id_listì— í¬í•¨ë˜ëŠ” í–‰ì„ ì°¾ìŒ
                    # ì£¼ì˜: ì—‘ì…€ì˜ ë¬¸í•­ ë²ˆí˜¸ íƒ€ìž…ê³¼ ì¼ì¹˜í•´ì•¼ í•¨ (ë‘˜ ë‹¤ ë¬¸ìžì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ ì¶”ì²œ)
                    mask = df['ë¬¸í•­'].astype(str).isin(id_list)
                    
                    if mask.any():
                        # í•´ë‹¹ í–‰ë“¤ì˜ 'ë‹´ë‹¹ìœ„ì›' ì»¬ëŸ¼ ì—…ë°ì´íŠ¸
                        df.loc[mask, 'ë‹´ë‹¹ìœ„ì›'] = target_member
                        conn.update(data=df)
                        st.success(f"{target_member} ìœ„ì›ì—ê²Œ ë¬¸í•­ {target_ids}ë²ˆì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
                    else:
                        st.error("ìž…ë ¥í•˜ì‹  ë¬¸í•­ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                        
                except Exception as e:
                    st.error(f"ì˜¤ë¥˜ ë°œìƒ: {e}")
            else:
                st.warning("ì´ë¦„ê³¼ ë¬¸í•­ ë²ˆí˜¸ë¥¼ ëª¨ë‘ ìž…ë ¥í•´ì£¼ì„¸ìš”.")

        st.divider()

        st.subheader("2. ì „ì²´ ê²°ê³¼ ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ")
        st.dataframe(df)

        # ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì•„ë‹˜ (Streamlit native ë°©ì‹) -> CSV ë‹¤ìš´ë¡œë“œ
        csv = df.to_csv(index=False).encode('utf-8-sig')
        st.download_button(
            label="ì „ì²´ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ",
            data=csv,
            file_name='checklist_results.csv',
            mime='text/csv',
        )
    
    elif admin_pw:
        st.error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.")